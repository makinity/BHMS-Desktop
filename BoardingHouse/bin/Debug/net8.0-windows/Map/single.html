<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Single Boarding House Map</title>

    <!-- LOCAL Leaflet -->
    <link rel="stylesheet" href="leaflet/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #e9ecef;
        }

        #status {
            position: fixed;
            z-index: 9999;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.80);
            color: #fff;
            padding: 5px 7px;
            font-size: 11px;
            border-radius: 6px;
            font-family: "Segoe UI", Arial, sans-serif;
            max-width: 240px;
            max-height: 120px;
            overflow: auto;
            line-height: 1.25;
            white-space: pre-line;
            pointer-events: none;
        }

        .leaflet-popup-content-wrapper {
            padding: 3px 5px;
        }

        .leaflet-popup-content {
            margin: 5px 6px;
            font-size: 11px;
            line-height: 1.25;
        }
    </style>
</head>
<body>
    <div id="status">Waiting for boarding house data…</div>
    <div id="map"></div>

    <script src="leaflet/leaflet.js"></script>

    <script>
        const statusEl = document.getElementById("status");

        const fallbackCenter = [6.7490, 125.3572];

        if (typeof L === "undefined") {
            statusEl.textContent = "Leaflet NOT loaded (check leaflet/leaflet.js)";
            console.error("Leaflet NOT loaded: L is undefined");
        } else {
            if (L.Icon && L.Icon.Default) {
                if (L.Icon.Default.prototype._getIconUrl) {
                    delete L.Icon.Default.prototype._getIconUrl;
                }
                L.Icon.Default.mergeOptions({
                    iconRetinaUrl: "https://appassets/leaflet/images/marker-icon-2x.png",
                    iconUrl: "https://appassets/leaflet/images/marker-icon.png",
                    shadowUrl: "https://appassets/leaflet/images/marker-shadow.png"
                });
            }
        }

        let map = null;
        let marker = null;

        function ensureMap() {
            if (map || typeof L === "undefined") return;

            map = L.map("map", {
                center: fallbackCenter,
                zoom: 13,
                zoomControl: true
            });

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors"
            }).addTo(map);
        }

        function escapeHtml(str) {
            return String(str ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        window.invalidateMap = function () {
            if (!map) return;
            setTimeout(() => map.invalidateSize(true), 150);
        };

        window.renderBoardingHouse = function (bh) {
            try {
                ensureMap();
                if (!map) return;

                if (!bh || typeof bh.latitude !== "number" || typeof bh.longitude !== "number") {
                    statusEl.textContent = "Invalid boarding house coordinates.";
                    console.error("Invalid bh payload:", bh);
                    return;
                }

                const lat = bh.latitude;
                const lng = bh.longitude;

                map.setView([lat, lng], 16);

                if (!marker) {
                    marker = L.marker([lat, lng]).addTo(map);
                } else {
                    marker.setLatLng([lat, lng]);
                }

                const name = escapeHtml(bh.name);
                const address = escapeHtml(bh.address);
                const status = escapeHtml(bh.status);
                const contact = escapeHtml(bh.contactNo || bh.contact_no || "");

                let html = `<div style="font-family:Segoe UI, Arial; font-size:11px; line-height:1.25;">
                        <div style="font-weight:600; font-size:12px; margin-bottom:2px;">${name || "Boarding House"}</div>
                        ${status ? `<div><b>Status:</b> ${status}</div>` : ""}
                        ${address ? `<div><b>Address:</b> ${address}</div>` : ""}
                        ${contact ? `<div><b>Contact:</b> ${contact}</div>` : ""}
                        <div><b>Lat:</b> ${Number(lat).toFixed(6)}</div>
                        <div><b>Lng:</b> ${Number(lng).toFixed(6)}</div>
                    </div>`;

                marker.bindPopup(html, {
                    maxWidth: 220,
                    minWidth: 140,
                    closeButton: false,
                    autoPan: true,
                    autoPanPaddingTopLeft: [10, 60],
                    autoPanPaddingBottomRight: [10, 10]
                }).openPopup();

                const overlayH = statusEl.offsetHeight || 0;
                const panY = -Math.round(Math.max(40, overlayH / 2));
                setTimeout(() => {
                    if (!map) return;
                    map.panBy([0, panY], { animate: true });
                }, 0);

                statusEl.textContent =
                    `Showing:\n${bh.name || "Boarding House"}\nLat: ${Number(lat).toFixed(6)}\nLng: ${Number(lng).toFixed(6)}`;

                window.invalidateMap();
            } catch (e) {
                console.error("renderBoardingHouse failed:", e);
                statusEl.textContent = "Failed to render boarding house.";
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            ensureMap();
        });

        window.resetSingleMap = function () {
            ensureMap();
            if (!map) return;

            if (marker) {
                try { map.removeLayer(marker); } catch (e) { }
                marker = null;
            }
            map.setView([6.7490, 125.3572], 13);

            statusEl.textContent = "Waiting for boarding house data…";

            window.invalidateMap();
        };


    </script>
</body>
</html>
